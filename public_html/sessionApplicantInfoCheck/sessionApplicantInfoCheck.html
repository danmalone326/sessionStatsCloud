<html>
<head>
<title>GLAARG Session Applicant Info Check</title>
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-32x32.jpg" sizes="32x32" />
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-180x180.jpg" />

<script>
// https://exam.tools/api/uls/lookup/$callsign
// https://exam.tools/api/uls/lookup/$frn
// https://apps.fcc.gov/coresWeb/simpleSearch.do
// https://apps.fcc.gov/coresWeb/searchDetail.do?frn=$FRN

var etApplicantLookupURLPrefix = "https://exam.tools/api/uls/lookup/";
var coresApplicantLookupURL = "https://apps.fcc.gov/coresWeb/simpleSearch.do?btnSearch=true";

// ULS API does not allow CORS
// var licenseSearchURLPrefix = "https://data.fcc.gov/api/license-view/basicSearch/getLicenses?sortColumn=expiredDate&format=json&searchValue=";

// Plan B
var myRegex = /(glaarg(?:-test)?)/;
var match = myRegex.exec(window.location.pathname);
var licenseSearchURLPrefix = "https://www.malone.org/cgi-bin/" + match[1] + "/ulsLookup.py?";


var coresFormPrefix = "coresLookup";
var coresPopupTarget = "CORES Popup";
var iFrameID = "ulsiFrame";

var loadDataFileNameID = "loadDataFileName";
var outputID = "outputDiv";
var applicantCheckIDPrefix = "applicantCheck"; // append PIN to this

window.sessionData = [];
var etDataKey = "etData";
var ulsDataKey = "ulsData";
var pendingKey = "pending";

var matchValueClass = "matchValue";
var similarValueClass = "similarValue";
var differentValueClass = "differentValue";

function checkDisplayWarning() {
// 	console.log(document.location.href.includes('glaarg-test'));
	if (document.location.href.includes('glaarg-test')) {
		document.getElementById('warning-wrapper').style.display='block';
	}
}

// Routines for loading JSON results
function getJSON(url, index, name, callback) {
	var xhr = new XMLHttpRequest();
	xhr.open('GET', url, true);
	xhr.responseType = 'json';
	xhr.onload = function() {
		var status = xhr.status;
		if (status === 200) {
			callback(null, xhr.response, index, name);
		} else {
			callback(status, xhr.response, index, name);
		}
	};
	xhr.send();
	window.sessionData.applicants[index].data[pendingKey]++;
};

function jsonCallback(err, data, index, name) {
	var result = {};
	if (err !== null) {
		console.log('Something is odd: ' + err + ", index: " + index + ", name: " + name);
	} else {
		result = data;
		window.sessionData.applicants[index].data[name] = result;
	}
	if (--window.sessionData.applicants[index].data[pendingKey] == 0) {
		outputApplicantData(index);
	}
};

function loadApplicantData(index) {
	var jsonURL;
	var name;
	var applicationData = window.sessionData.applicants[index];
	window.sessionData.applicants[index].data = {};
	window.sessionData.applicants[index].data[pendingKey] = 0;

	if ((applicationData.callsign) || (applicationData.frn)) {
		jsonURL = licenseSearchURLPrefix + "frn=" + applicationData.frn;
		if (applicationData.callsign) {
			jsonURL += "&callsign=" + applicationData.callsign;
		}
		
		getJSON(jsonURL, index, ulsDataKey, jsonCallback);
	}

	if (applicationData.callsign) {
		jsonURL = etApplicantLookupURLPrefix + applicationData.callsign;
		getJSON(jsonURL, index, etDataKey, jsonCallback);
	}
}

function ulsDataSort(a,b) {
	var result = 0;
	var sortA = a.expiredDate.substring(6,10) + a.expiredDate.substring(0,2) + a.expiredDate.substring(3,5) + a.statusDesc;
	var sortB = b.expiredDate.substring(6,10) + b.expiredDate.substring(0,2) + b.expiredDate.substring(3,5) + b.statusDesc;
	if (expA < expB) {
		result = -1;
	} else if (expA > expB) {
		result = 1;
	} 
	return result;
}

function compareETDataHTML(attributeName,applicationValue,fccValue) {
	var rowClass = "";

	if (applicationValue === fccValue) {
		rowClass = matchValueClass;
	} else if ((applicationValue.toUpperCase() === fccValue.toUpperCase()) ||
			   ((attributeName == "Zip") && 
			    ((applicationValue.replace(/-/,"") === fccValue.replace(/-/,"")) || 
				 (applicationValue.substring(0,3) === fccValue.substring(0,3))))
			   ) {
		rowClass = similarValueClass;
	} else {
		rowClass = differentValueClass;
	}

	var htmlOutput = "";

	htmlOutput += "<tr class='" + rowClass + "'>";
	// htmlOutput += "<td>" + attributeName + "</td>";
	htmlOutput += "<td>" + applicationValue + "</td>";
	htmlOutput += "<td>" + fccValue + "</td>";
	htmlOutput += "</tr>";

	return htmlOutput;
}

function whatETSeesHTML(index) {
	var htmlOutput = "";
	var applicationData = window.sessionData.applicants[index];

	if (etDataKey in applicationData.data) {

		var applicantUlsData = applicationData.data[etDataKey];

		htmlOutput += "<h3>What ExamTools sees</h3>";
		htmlOutput += "<table>";

		htmlOutput += "<tr>";
		// htmlOutput += "<th></th>";
		htmlOutput += "<th>Application</th>";
		htmlOutput += "<th>ETs copy of ULS</th>";
		htmlOutput += "</tr>";

		htmlOutput += compareETDataHTML('First Name',applicationData.firstname,applicantUlsData.first_name);
		htmlOutput += compareETDataHTML('Middle Initial',applicationData.middle,applicantUlsData.middle_initial);
		htmlOutput += compareETDataHTML('Last Name',applicationData.lastname,applicantUlsData.last_name);
		htmlOutput += compareETDataHTML('Suffix',applicationData.suffix,applicantUlsData.suffix);

		htmlOutput += compareETDataHTML('Address',applicationData.addr,applicantUlsData.address);
		htmlOutput += compareETDataHTML('City',applicationData.city,applicantUlsData.city);
		htmlOutput += compareETDataHTML('State',applicationData.state,applicantUlsData.state);
		htmlOutput += compareETDataHTML('Zip',applicationData.zip,applicantUlsData.zip);

		htmlOutput += "</table>"
		// htmlOutput += JSON.stringify(applicationData);
		// htmlOutput += "<br>";
		// htmlOutput += JSON.stringify(applicantUlsData);
	}

	return htmlOutput;
}

// sort by expiredDate desc, statusDesc
function ulsDataSort(a,b) {
	var result = 0;
	var sortA = a.expiredDate.substring(6,10) + a.expiredDate.substring(0,2) + a.expiredDate.substring(3,5);
	var sortB = b.expiredDate.substring(6,10) + b.expiredDate.substring(0,2) + b.expiredDate.substring(3,5);
	if (expA > expB) {
		result = -1;
	} else if (expA < expB) {
		result = 1;
	} else {
		if (a.statusDesc < b.statusDesc) {
			result = -1;
		} else if (a.statusDesc > b.statusDesc) {
			result = 1;
		}
	}

	return result;
}

function ulsCheckHTML(index) {
	var dataClass = "";
	var htmlOutput = "";
	var applicationData = window.sessionData.applicants[index];

	if (ulsDataKey in applicationData.data) {

		var applicantUlsData = applicationData.data[ulsDataKey];

		htmlOutput += "<h3>ULS Entries</h3>";

		if (applicantUlsData.length == 0) {
			htmlOutput += "No Amateur Licenses found in ULS for this FRN or Callsign.";
		} else {

			htmlOutput += "<table><tr><td>";
				htmlOutput += applicationData.lastname 
							+ (applicationData.suffix ? " " + applicationData.suffix : "")
							+ ", " + applicationData.firstname 
							+ " " + applicationData.middle + "<br>";
				htmlOutput += applicationData.addr + "<br>";
				htmlOutput += applicationData.city + ", " + applicationData.state + " " + applicationData.zip + "<br>";
			htmlOutput += "</td></tr></table>";

			htmlOutput += "<table class='coresTable'>";

			htmlOutput += "<tr>";
			htmlOutput += "<th>FRN</th>";
			htmlOutput += "<th>Call Sign</th>";
			htmlOutput += "<th>Status</th>";
			htmlOutput += "<th></th>";
			htmlOutput += "</tr>";

			applicationData.data[ulsDataKey].forEach(function (item, index) {
				item.licDetailURL = item.licDetailURL.replace("http://","https://");
				htmlOutput += "<tr>";

				dataClass = matchValueClass;
				if (item.frn !== applicationData.frn){
					dataClass = differentValueClass;
				}
				htmlOutput += "<td class='" + dataClass + "'>" + item.frn + "</td>";

				dataClass = matchValueClass;
				if (item.callsign !== applicationData.callsign) {
					dataClass = differentValueClass;
				}
				htmlOutput += "<td class='" + dataClass + "'>" + item.callsign + "</td>";

				htmlOutput += "<td>" + item.statusDesc + "</td>";

				var formID = coresFormPrefix + "-" + applicationData.pin + "-" + item.licenseID;
				htmlOutput += "<td>";
				htmlOutput += "<form id='" + formID + 
								"' target='" + coresPopupTarget + 
								"' action='" + item.licDetailURL + 
								"' method='POST' >";
				htmlOutput += "<button onclick='coresPopup(\"" + formID + "\")'>Open ULS Entry</button>";
				htmlOutput += "</td>";
				htmlOutput += "</form>";
				htmlOutput += "</tr>";
			});

			htmlOutput += "</table>"
			// htmlOutput += JSON.stringify(applicationData);
			// htmlOutput += "<br>";
			// htmlOutput += JSON.stringify(applicantUlsData);
		}
	}

	return htmlOutput;
}

function coresPopup(formID) {
	var myWindow = window.open("", coresPopupTarget, "status=0,title=0,height=800,width=600,scrollbars=1");

	if (myWindow) {
		document.getElementById(formID).submit();
	} else {
		alert('You must allow popups for this to work.');
	}
	return true;
}

function coresFrnSearchHTML(frn) {
	var htmlOutput = "";
	var formID = coresFormPrefix + frn;

	htmlOutput += "<form id='" + formID + 
					"' target='" + coresPopupTarget + 
					"' action='" + coresApplicantLookupURL + 
					"' method='POST' >";
	htmlOutput += "<input type=hidden name=simpleSearchName value=Frn>";
	htmlOutput += "<input type=hidden name=simpleSearchValue value=" + frn + ">";
	htmlOutput += "<button onclick='coresPopup(\"" + formID + "\")'>Open CORES Entry</button>";
	htmlOutput += "</form>";

	return htmlOutput;
}

function coresCheckHTML(index) {
	var htmlOutput = "";
	var applicationData = window.sessionData.applicants[index];

	htmlOutput += "<h3>CORES Entry</h3>";
	htmlOutput += "<table class='coresTable'><tr>";
	htmlOutput += "<td>" + applicationData.lastname 
						+ ", " + applicationData.firstname 
						+ " " + applicationData.middle
						+ (applicationData.suffix ? " " + applicationData.suffix : "")
						+ "</td>";
	htmlOutput += "<td>";
	htmlOutput += coresFrnSearchHTML(applicationData.frn);
	htmlOutput += "</td>";
	htmlOutput += "</tr></table>";

	return htmlOutput;
}


function outputApplicantData(index) {
	var htmlOutput = "";
	var applicant = window.sessionData.applicants[index];

	htmlOutput += whatETSeesHTML(index);
	htmlOutput += ulsCheckHTML(index);
	htmlOutput += coresCheckHTML(index);
	
	var divID = applicantCheckIDPrefix + index;
	document.getElementById(divID).innerHTML = htmlOutput;
}

function outputApplicants() {
	var frnList = [];
	var frnDupe = false;
	var htmlOutput = "";

	htmlOutput += "<center>";
	htmlOutput += "<hr>";

	window.sessionData.applicants.forEach(function (item, index) {
		if (frnList.includes(item.frn)) {
			frnDupe = true;
		} else {
			frnDupe = false;
			frnList.push(item.frn);
		}

		htmlOutput += "<h2>";
		htmlOutput += "PIN: " + item.pin;
		htmlOutput += " FRN: " + item.frn;
		htmlOutput += (item.callsign ? " Callsign: " + item.callsign : "");
		if (frnDupe) {
			htmlOutput += " <span style=\"color:red\">DUPE</span> ";
		}
		htmlOutput += "</h2>";
		
		var divID = applicantCheckIDPrefix + index;
		htmlOutput += "<div id=\"" + divID +"\">Loading...</div>";

		htmlOutput += "<hr>";

		loadApplicantData(index);
	});

	htmlOutput += "</center>";

	document.getElementById(outputID).innerHTML = htmlOutput;
}

//loadDataFileName
function loadData() {
	var fileSelector = document.getElementById(loadDataFileNameID);
	
	fileSelector.value = "";
	fileSelector.click();
}

function dataFileNameUpdated() {
	var fileSelector = document.getElementById(loadDataFileNameID);

  if (fileSelector.value.length != 0) {
    var file = fileSelector.files[0];
    var reader = new FileReader();
    
    reader.readAsBinaryString(file);
    reader.onloadend = function() {
		window.sessionData = JSON.parse(reader.result);
		outputApplicants();
		// inputChange();
	}
  }	
}

function handleByLine() {
	var byLineDiv = document.querySelector('#byLine');

	byLineDiv.addEventListener('onmouseover',(event) => {
		document.getElementById('support').style.display='block';
		console.log('clicked');
	});
	byLineDiv.addEventListener('onmouseleave',(event) => {
		document.getElementById('support').style.display='none';
		console.log('clicked');
	});
	console.log('setup');
	// onmouseenter="d" ="document.getElementById('support').display='none';"
}

function onLoad() {
//	checkDisplayWarning(); 
	handleByLine();
	return true;
}

</script>

<style type="text/css">
td {
    padding:2 15px;
    white-space: nowrap;
}
#statsOutput {
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
}

#warning-wrapper {
	display: none;
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	z-index: 10;
	background-color: rgba(0,0,0,0.5);
	padding: 25px;
}
#warning {
	width: 50%;
	height: auto;
	margin: 0 auto;
	padding: 10px;
	position: relative;
	text-align: center;
	background-color: rgb(255,255,0);
	border-radius: 25px;
}

.matchValue {
	background-color: #eff9ef;
}

.similarValue {
	background-color: #f6f7b2;
}

.differentValue {
	background-color: #f7c6b2;
}

.coresTable {
	vertical-align: middle;
}

.coresTable form {
	margin-block-end: 0em;
}

.column {
  float: left;
  width: 33.33%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.warning {
  background-color: rgba(252, 248, 227, 1);
  border-color: rgba(177, 161, 129, 1);
  color: rgba(138, 109, 59, 1);
  padding: 12px 16px;
  border-radius: 4px;
  border-style: solid;
  border-width: 1px;
  margin-bottom: 12px;
}

.byLine {
	position: fixed; 
	bottom: 10; 
	right: 10; 
	padding: 5; 
	border-radius: 5px;
    background: #cacaca73;
	background-color: #cacaca73; 
	font-size: x-small;
	width: 6em;
	text-align: center;
	z-index: 1000;
}

.byLine:hover #support {
	display: block;
}

.support {
	position: fixed; 
	width: 200px;
	display: none;
	bottom: 30; 
	right: 10; 
	padding: 5; 
	border-radius: 5px;
    background: #cacaca73;
	background-color: #cacaca73; 
	font-size: x-small;
	text-align: left;
	z-index: 999;
}

</style>

</head>

<body onload='onLoad();'>
	<div id=warning-wrapper>
		<div id=warning>
			This is the TEST site, probably with inconsistent results.<br>
			<button type=button onclick='document.getElementById("warning-wrapper").style.display="none"; return true;'>Clear</button>
		</div>
	</div>

	<div class="headerBox">
		<center>
			<h1>GLAARG Session Applicant Info Check</h1>
			<form onsubmit="return false;">
				<input type=file id="loadDataFileName" style="display:none;" onchange="dataFileNameUpdated();">
				<button onclick="loadData()">Load Session Applicant JSON</button>
			</form>

			<div class="warning">This file will not leave your machine.<br>
				FRN and callsign will be used to query FCC and ET databases.</div>
			
		</center>
	</div>

	<div id="outputDiv">

	</div>

	<div id="byLine" class="byLine">
		by AK6DM
		<div id="support" class="support">
			&#128519; If using this page saves you time, consider supporting my efforts by giving credit for your sessions. 	
			<br>
			Every little bit helps in my quest for 150!
		</div>
	</div>
</body>
</html>
