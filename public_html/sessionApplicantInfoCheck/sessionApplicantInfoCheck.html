<html>
<head>
<title>GLAARG Session Applicant Info Check</title>
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-32x32.jpg" sizes="32x32" />
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-180x180.jpg" />

<script>
// https://exam.tools/api/uls/lookup/$callsign
// https://exam.tools/api/uls/lookup/$frn
// https://apps.fcc.gov/coresWeb/simpleSearch.do
// https://apps.fcc.gov/coresWeb/searchDetail.do?frn=$FRN

var etApplicantLookupURLPrefix = "https://exam.tools/api/uls/lookup/";
var coresApplicantLookupURL = "https://apps.fcc.gov/coresWeb/simpleSearch.do?btnSearch=true";

// ULS API does not allow CORS
// var licenseSearchURLPrefix = "https://data.fcc.gov/api/license-view/basicSearch/getLicenses?sortColumn=expiredDate&format=json&searchValue=";

// Plan B
var myRegex = /(glaarg(?:-test)?)/;
var match = myRegex.exec(window.location.pathname);
var licenseSearchURLPrefix = "https://www.malone.org/cgi-bin/" + match[1] + "/ulsLookup.py?";


var coresFormPrefix = "coresLookup";
var coresPopupTarget = "CORES Popup";

var loadDataFileNameID = "loadDataFileName";
var outputID = "outputDiv";
var applicantCheckIDPrefix = "applicantCheck"; // append PIN to this

window.sessionData = [];
var etDataKey = "etData";
var ulsDataKey = "ulsData";
var pendingKey = "pending";

function checkDisplayWarning() {
// 	console.log(document.location.href.includes('glaarg-test'));
	if (document.location.href.includes('glaarg-test')) {
		document.getElementById('warning-wrapper').style.display='block';
	}
}

// Routines for loading JSON results
function getJSON(url, index, name, callback) {
	var xhr = new XMLHttpRequest();
	xhr.open('GET', url, true);
	xhr.responseType = 'json';
	xhr.onload = function() {
		var status = xhr.status;
		if (status === 200) {
			callback(null, xhr.response, index, name);
		} else {
			callback(status, xhr.response, index, name);
		}
	};
	xhr.send();
	window.sessionData.applicants[index].data[pendingKey]++;
};

function jsonCallback(err, data, index, name) {
	var result = {};
	if (err !== null) {
		console.log('Something is odd: ' + err + ", index: " + index + ", name: " + name);
	} else {
		result = data;
		window.sessionData.applicants[index].data[name] = result;
	}
	if (--window.sessionData.applicants[index].data[pendingKey] == 0) {
		outputApplicantData(index);
	}
};

function loadApplicantData(index) {
	var jsonURL;
	var name;
	var applicationData = window.sessionData.applicants[index];
	window.sessionData.applicants[index].data = {};
	window.sessionData.applicants[index].data[pendingKey] = 0;

	if ((applicationData.callsign) || (applicationData.frn)) {
		jsonURL = licenseSearchURLPrefix + "frn=" + applicationData.frn;
		if (applicationData.callsign) {
			jsonURL += "&callsign=" + applicationData.callsign;
		}
		
		getJSON(jsonURL, index, ulsDataKey, jsonCallback);
	}

	if (applicationData.callsign) {
		jsonURL = etApplicantLookupURLPrefix + applicationData.callsign;
		getJSON(jsonURL, index, etDataKey, jsonCallback);
	}
}

function ulsDataSort(a,b) {
	var result = 0;
	var sortA = a.expiredDate.substring(6,10) + a.expiredDate.substring(0,2) + a.expiredDate.substring(3,5) + a.statusDesc;
	var sortB = b.expiredDate.substring(6,10) + b.expiredDate.substring(0,2) + b.expiredDate.substring(3,5) + b.statusDesc;
	if (expA < expB) {
		result = -1;
	} else if (expA > expB) {
		result = 1;
	} 
	return result;
}

function compareETDataHTML(attributeName,applicationValue,fccValue) {
	var status = "";

	if (applicationValue === fccValue) {
		status = "match";
	} else if ((applicationValue.toUpperCase() === fccValue.toUpperCase()) ||
			   ((attributeName == "Zip") && 
			    ((applicationValue.replace(/-/,"") === fccValue.replace(/-/,"")) || 
				 (applicationValue.substring(0,3) === fccValue.substring(0,3))))
			   ) {
		status = "similar";
	} else {
		status = "different";
	}

	var htmlOutput = "";

	htmlOutput += "<tr class='" + status + "Row'>";
	htmlOutput += "<td>" + attributeName + "</td>";
	htmlOutput += "<td>" + applicationValue + "</td>";
	htmlOutput += "<td>" + fccValue + "</td>";
	htmlOutput += "</tr>";

	return htmlOutput;
}

function whatETSeesHTML(index) {
	var htmlOutput = "";
	var applicationData = window.sessionData.applicants[index];

	if (etDataKey in applicationData.data) {

		var applicantUlsData = applicationData.data[etDataKey];

		htmlOutput += "<h3>What ExamTools sees</h3>";
		htmlOutput += "<table>";

		htmlOutput += "<tr>";
		htmlOutput += "<th></th>";
		htmlOutput += "<th>Application</th>";
		htmlOutput += "<th>ULS (via ET API)</th>";
		htmlOutput += "</tr>";

		htmlOutput += compareETDataHTML('First Name',applicationData.firstname,applicantUlsData.first_name);
		htmlOutput += compareETDataHTML('Middle Initial',applicationData.middle,applicantUlsData.middle_initial);
		htmlOutput += compareETDataHTML('Last Name',applicationData.lastname,applicantUlsData.last_name);
		htmlOutput += compareETDataHTML('Suffix',applicationData.suffix,applicantUlsData.suffix);

		htmlOutput += compareETDataHTML('Address',applicationData.addr,applicantUlsData.address);
		htmlOutput += compareETDataHTML('City',applicationData.city,applicantUlsData.city);
		htmlOutput += compareETDataHTML('State',applicationData.state,applicantUlsData.state);
		htmlOutput += compareETDataHTML('Zip',applicationData.zip,applicantUlsData.zip);

		htmlOutput += "</table>"
		// htmlOutput += JSON.stringify(applicationData);
		// htmlOutput += "<br>";
		// htmlOutput += JSON.stringify(applicantUlsData);
	}

	return htmlOutput;
}

function ulsDataSort(a,b) {
	var result = 0;
	var sortA = a.expiredDate.substring(6,10) + a.expiredDate.substring(0,2) + a.expiredDate.substring(3,5) + a.statusDesc;
	var sortB = b.expiredDate.substring(6,10) + b.expiredDate.substring(0,2) + b.expiredDate.substring(3,5) + b.statusDesc;
	if (expA < expB) {
		result = -1;
	} else if (expA > expB) {
		result = 1;
	} 
	return result;
}

function ulsCheckHTML(index) {
	var htmlOutput = "";
	var applicationData = window.sessionData.applicants[index];

	if (ulsDataKey in applicationData.data) {

		var applicantUlsData = applicationData.data[ulsDataKey];

		htmlOutput += "<h3>ULS Checks</h3>";

		htmlOutput += "<table>";

		htmlOutput += "<tr>";
		htmlOutput += "<th></th>";
		htmlOutput += "<th></th>";
		htmlOutput += "<th></th>";
		htmlOutput += "</tr>";

		htmlOutput += compareDataHTML('First Name',applicationData.firstname,applicantUlsData.first_name);
		htmlOutput += compareDataHTML('Middle Initial',applicationData.middle,applicantUlsData.middle_initial);
		htmlOutput += compareDataHTML('Last Name',applicationData.lastname,applicantUlsData.last_name);
		htmlOutput += compareDataHTML('Suffix',applicationData.suffix,applicantUlsData.suffix);

		htmlOutput += compareDataHTML('Address',applicationData.addr,applicantUlsData.address);
		htmlOutput += compareDataHTML('City',applicationData.city,applicantUlsData.city);
		htmlOutput += compareDataHTML('State',applicationData.state,applicantUlsData.state);
		htmlOutput += compareDataHTML('Zip',applicationData.zip,applicantUlsData.zip);

		htmlOutput += "</table>"
		// htmlOutput += JSON.stringify(applicationData);
		// htmlOutput += "<br>";
		// htmlOutput += JSON.stringify(applicantUlsData);
	}

	return htmlOutput;
}

function coresFrnSearchPopup(frn) {
	var myWindow = window.open("", coresPopupTarget, "status=0,title=0,height=100,width=200,scrollbars=1");

	if (myWindow) {
		document.getElementById(coresFormPrefix + frn).submit();
	} else {
		alert('You must allow popups for this to work.');
	}
}

function coresFrnSearchHTML(frn) {
	var htmlOutput = "";

	htmlOutput += "<form id='" + coresFormPrefix + frn + 
					"' target='" + coresPopupTarget + 
					"' action='" + coresApplicantLookupURL + 
					"' method='POST' >";
	htmlOutput += "<input type=hidden name=simpleSearchName value=Frn>";
	htmlOutput += "<input type=hidden name=simpleSearchValue value=" + frn + ">";
	htmlOutput += "<button onclick='coresFrnSearchHTML(" + frn + ")'>Compare to CORES</button>";
	htmlOutput += "</form>";

	return htmlOutput;
}

function coresCheckHTML(index) {
	var htmlOutput = "";
	var applicationData = window.sessionData.applicants[index];

	htmlOutput += "<h3>CORES Checks</h3>";
	htmlOutput += "<table class='coresTable'><tr>";
	htmlOutput += "<td>" + applicationData.lastname + ", " + applicationData.firstname + " " + applicationData.middle + "</td>";
	htmlOutput += "<td>";
	htmlOutput += coresFrnSearchHTML(applicationData.frn);
	htmlOutput += "</td>";
	htmlOutput += "</tr></table>";

	return htmlOutput;
}


function outputApplicantData(index) {
	var htmlOutput = "";
	var applicant = window.sessionData.applicants[index];

	htmlOutput += whatETSeesHTML(index);

	htmlOutput += coresCheckHTML(index);
	
	var divID = applicantCheckIDPrefix + index;
	document.getElementById(divID).innerHTML = htmlOutput;
}

function outputApplicants() {
	var frnList = [];
	var frnDupe = false;
	var htmlOutput = "";

	htmlOutput += "<center>";
	htmlOutput += "<hr>";

	window.sessionData.applicants.forEach(function (item, index) {
		if (frnList.includes(item.frn)) {
			frnDupe = true;
		} else {
			frnDupe = false;
			frnList.push(item.frn);
		}
		htmlOutput += "PIN: " + item.pin;
		htmlOutput += " FRN: " + item.frn;
		htmlOutput += (item.callsign ? " Callsign: " + item.callsign : "");
		if (frnDupe) {
			htmlOutput += " <span style=\"color:red\">DUPE</span> ";
		}
		htmlOutput += "<br>";
		var divID = applicantCheckIDPrefix + index;
		htmlOutput += "<div id=\"" + divID +"\">Loading...</div>";

		htmlOutput += "<hr>";

		loadApplicantData(index);
	});

	htmlOutput += "</center>";

	document.getElementById(outputID).innerHTML = htmlOutput;
}

//loadDataFileName
function loadData() {
	var fileSelector = document.getElementById(loadDataFileNameID);
	
	fileSelector.value = "";
	fileSelector.click();
}

function dataFileNameUpdated() {
	var fileSelector = document.getElementById(loadDataFileNameID);

  if (fileSelector.value.length != 0) {
    var file = fileSelector.files[0];
    var reader = new FileReader();
    
    reader.readAsBinaryString(file);
    reader.onloadend = function() {
		window.sessionData = JSON.parse(reader.result);
		outputApplicants();
		// inputChange();
	}
  }	
}

function onLoad() {
//	checkDisplayWarning(); 
	return true;
}

</script>

<style type="text/css">
td {
    padding:2 15px;
    white-space: nowrap;
}
#statsOutput {
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
}

#warning-wrapper {
	display: none;
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	z-index: 10;
	background-color: rgba(0,0,0,0.5);
	padding: 25px;
}
#warning {
	width: 50%;
	height: auto;
	margin: 0 auto;
	padding: 10px;
	position: relative;
	text-align: center;
	background-color: rgb(255,255,0);
	border-radius: 25px;
}

.matchRow {
	background-color: #b2f7b2;
}

.similarRow {
	background-color: #e2f7b2;
}

.differentRow {
	background-color: #f7c6b2;
}

.coresTable {
	vertical-align: middle;
}

.coresTable form {
	margin-block-end: 0em;
}

.column {
  float: left;
  width: 33.33%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

</style>

</head>

<body onload='onLoad();'>
	<div id=warning-wrapper>
		<div id=warning>
			This is the TEST site, probably with inconsistent results.<br>
			<button type=button onclick='document.getElementById("warning-wrapper").style.display="none"; return true;'>Clear</button>
		</div>
	</div>

	<div class="headerBox">
	<center><h1>GLAARG Session Applicant Info Check</h1></center>
	</div>

	<form onsubmit="return false;">

	<div>
		<center>
			<input type=file id="loadDataFileName" style="display:none;" onchange="dataFileNameUpdated();">
			<button onclick="loadData()">Load Session Applicant JSON</button>
		</center>
	</div>

	</form>

	<div id="outputDiv">

	</div>


</body>
</html>
