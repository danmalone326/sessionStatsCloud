<html>
<head>
<title>GLAARG Session Stats</title>
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-32x32.jpg" sizes="32x32" />
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-180x180.jpg" />

<script>
var jsonURL = "sessionStats.json";
var inputID = "veInput";
var veCountID = "veCount";
var roomCountID = "roomCount";
var showSessionsID = "showSessions";
var outputID = "statsOutput";


window.stats = "";
window.selectedList = [];
window.maybeList = [];

// Routines for loading the JSON stats file
var getJSON = function(url, callback) {
					var xhr = new XMLHttpRequest();
					xhr.open('GET', url, true);
					xhr.responseType = 'json';
					xhr.onload = function() {
						var status = xhr.status;
						if (status === 200) {
							callback(null, xhr.response);
						} else {
							callback(status, xhr.response);
						}
					};
					xhr.send();
				};

function loadJSON () {
	getJSON(jsonURL,
			function(err, data) {
				if (err !== null) {
					alert('Something went wrong: ' + err);
				} else {
					window.stats=data;
				}
			});
}

function compareBySessionsDec(a,b) {
	var result = 0;
  	if (a.sessions > b.sessions) {
		result = -1;
  	} else if (a.sessions < b.sessions) {
    	result = 1;
  	}
  	return result;
}

function redrawTable() {
	var selectedList = window.selectedList;
	var maybeList = window.maybeList;
	var roomCount = Number(document.getElementById(roomCountID).value);
	var showSessions = document.getElementById(showSessionsID).checked;
	
	var htmlOutput = "<center><table><tr>";
	
	for (let i = 1; i <= roomCount; i++) {
		htmlOutput += "<th>Room "+i+"</th>";
	}
	htmlOutput += "</tr>";
	
	selectedList.forEach(function (item, index) {
		if (index == 0) {
			htmlOutput += "<tr>";
		} else if (index%roomCount == 0) {
			htmlOutput += "</tr><tr>";		
		}
		htmlOutput += "<td>";
		htmlOutput += item.veNum+"-"+item.callsign+" "+item.name;
		if (showSessions) {
			htmlOutput += " ("+item.sessions+")";
		}
		htmlOutput += "</td>";
	})
	
	htmlOutput += "</tr>";

	if (maybeList.length > 0) {
		maybeList.forEach(function (item, index) {
			if (index == 0) {
				htmlOutput += "<tr>";
			} else if (index%roomCount == 0) {
				htmlOutput += "</tr><tr>";
			}
			htmlOutput += "<td>";
			htmlOutput += item;
			if (showSessions) {
				htmlOutput += " (?)";
			}
			htmlOutput += "</td>";
		})
	}

	htmlOutput += "</tr>";

	htmlOutput += "</table></center>";
	
	document.getElementById(outputID).innerHTML = htmlOutput;
	
	return true;
}

function inputChange() {
	var input = document.getElementById(inputID).value;
	var inputList = input.split(/\W+/);
	var selectedList = [];
	var maybeList = [];
	
	inputList.forEach(function (inputItem, inputIndex) {
							var matched = false;
							window.stats.individual.forEach(function (statsItem, statsIndex) {
															  if ((statsItem.veNum == inputItem.toUpperCase()) ||
															      (statsItem.callsign == inputItem.toUpperCase())) {
																	matched = true;
																	selectedList.push(statsItem);
																}
															});
							if (!matched) {
								// Does this look like a callsign or a VE Number?
								if (inputItem.toUpperCase().match(/^(\d{4}[EG]|[A-Z]{1,2}\d[A-Z]{1,3})$/)) {
									maybeList.push(inputItem.toUpperCase());
								}
							}
						})
	
	// dedup
	selectedList = selectedList.filter(function (value, index, self) { return self.indexOf(value) === index; });
	maybeList = maybeList.filter(function (value, index, self) { return self.indexOf(value) === index; });
	
	selectedList.sort(compareBySessionsDec);
	window.selectedList = selectedList;
	
	maybeList.sort();
	window.maybeList = maybeList;
	
	var countText = selectedList.length+" VE"+ (selectedList.length==1 ? "" : "s") +" found";
	countText += (maybeList.length==0?"": " plus "+maybeList.length+" possible new VE"+ (maybeList.length==1 ? "" : "s") );
	document.getElementById(veCountID).innerHTML = countText;
	
	return redrawTable();
}

</script>

<style type="text/css">
td {
    padding:2 15px;
    white-space: nowrap;
}
#statsOutput {
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
}
</style>

</head>

<body onload='document.getElementById("veInput").focus(); loadJSON();'"'>
	<div class="outerBox">
		<div class="headerBox">
		<center><h1>Session Prep Stats</h1></center>
		</div>

		<div id="inputDiv">
		<center>
		<form onsubmit="return false;">
			<textarea id="veInput" rows="10" cols="30" placeholder="Paste a list of VE #s or Callsigns here..." onchange="inputChange();"></textarea>
			<br>
			<div id=veCount>0 VEs found</div>
			<br>
			Rooms: <input type=number id=roomCount value=1 min=1 max=20 onchange="redrawTable();"/>
			<br>
			<input type=checkbox id=showSessions checked onchange="redrawTable();"> Show session count
			<br>
			<br>
			<button type=button>Go</button>
		</form>
		</center>
		</div>

		<div id="statsOutput">
		</div>
	</div>
</body>
</html>
