<html>
<head>
<title>GLAARG Session Prep</title>
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-32x32.jpg" sizes="32x32" />
<link rel="icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon" href="https://glaarg.org/wp-content/uploads/2018/05/cropped-glaarglogoyellowblack-180x180.jpg" />

<script>
var jsonURL = "https://glaarglookup.n1cck.com/websiteStatsDetail"
// var jsonURL = "sessionStats.json";
var inputID = "veInput";
var veCountID = "veCount";
var roomCountID = "roomCount";
var showSessionsID = "showSessions";
var veDataListID = "veDataList";

var assignmentDivID = "roomAssignmentDiv";
var assignmentNumberPrefix = "assignmentNumber";
var assignmentRoomPrefix = "assignmentRoom";
var assignmentDataListID = "assignmentDataList";
var assignmentNumberWidth = 30;
var assignmentRoomWidth = 15;

var specialRoomInputID = "specialRoomInput";
var specialRoomDataListID = "specialRoomDataList";

var loadDataFileNameID = "loadDataFileName";

var outputID = "statsOutput";


window.stats = "";
window.selectedList = [];
window.maybeList = [];
window.roomAssignments = [];
window.specialRooms = ['Main','Welcome','Precheck','Ready'];
window.finalRoomAssignments = {};

function checkDisplayWarning() {
// 	console.log(document.location.href.includes('glaarg-test'));
	if (document.location.href.includes('glaarg-test')) {
		document.getElementById('warning-wrapper').style.display='block';
	}
}

// Routines for loading the JSON stats file
var getJSON = function(url, callback) {
					var xhr = new XMLHttpRequest();
					xhr.open('GET', url, true);
					xhr.responseType = 'json';
					xhr.onload = function() {
						var status = xhr.status;
						if (status === 200) {
							callback(null, xhr.response);
						} else {
							callback(status, xhr.response);
						}
					};
					xhr.send();
				};

function loadJSON () {
	getJSON(jsonURL,
			function(err, data) {
				if (err !== null) {
					alert('Something went wrong: ' + err);
				} else {
					window.stats=data;
				}
			});
}

var standardRoomPrefix = "Room ";
function standardRoomName(i) {
	return standardRoomPrefix + i;
}

function isStandardRoomName(name) {
	return name.startsWith(standardRoomName);
}

function veDisplay(ve) {
	var veObject;
	var result;

	if (typeof ve === 'object' && ve !== null) {
		veObject = ve;
	} else {
		veObject = getVEbyID(ve);
	}

	if (veObject) {
		var showSessions = document.getElementById(showSessionsID).checked;
		result = veObject.veNumber+"-"+veObject.veCallSign+" "+veObject.vePreferredName+(showSessions ? " ("+veObject.overallSessionCount+")" : "");
	} else {
		result = ve;
	}

	return result;
}

function getVEbyID(veNumber) {
	return window.stats.filter(ve => { return ve.veNumber === veNumber })[0];
}

function veID(ve) {
	return ve.veNumber;
}

// Used to sort VE list by session count
function compareBySessionsDec(a,b) {
	var result = 0;
  	if (a.overallSessionCount > b.overallSessionCount) {
		result = -1;
  	} else if (a.overallSessionCount < b.overallSessionCount) {
    	result = 1;
  	}
  	return result;
}

// Make an array of assignments for all VEs
function assignEveryone() {
	var finalRoomAssignments = {};
	var roomCount = Number(document.getElementById(roomCountID).value);
	var roomNum;
	var roomPass;
	
	// First fill the object with an array for each special and regular room
	window.specialRooms.forEach(function (item,index) {
		finalRoomAssignments[item] = [];
	});

	for (roomNum = 1; roomNum <= roomCount; roomNum++) {
		finalRoomAssignments[standardRoomName(roomNum)] = [];
	}

	// Now place the VEs who have special assignments
	for (var index in window.roomAssignments) {
		var assignment = window.roomAssignments[index];
		if (assignment["room"] && assignment["veNumber"]) {
			if (assignment["room"] in finalRoomAssignments) {
				finalRoomAssignments[window.roomAssignments[index]["room"]].push(window.roomAssignments[index]["veNumber"]);
			} else {
				console.log("Room " + assignment["room"] + " does not exist");
			}
		}
	}

	// Now place the unassigned VEs across the numbered rooms
	roomNum = 1;
	roomPass = 0; 
	window.selectedList.forEach(function (ve, index) {
		if (!veHasSpecialAssignment(ve.veNumber)) {

			// find the next slot
			while (finalRoomAssignments[standardRoomName(roomNum)].length > roomPass) {
				roomNum++;
				if (roomNum > roomCount) {
					roomNum = 1;
					roomPass++;
				}
			}

			finalRoomAssignments[standardRoomName(roomNum)].push(veID(ve));
		}
	});

	// Now place the maybes across the numbered rooms
	window.maybeList.forEach(function (maybe, index) {
		if (!veHasSpecialAssignment(maybe)) {

			// find the next slot
			while (finalRoomAssignments[standardRoomName(roomNum)].length > roomPass) {
				roomNum++;
				if (roomNum > roomCount) {
					roomNum = 1;
					roomPass++;
				}
			}

			finalRoomAssignments[standardRoomName(roomNum)].push(maybe);
		}
	})

	window.finalRoomAssignments = finalRoomAssignments;
}

function redrawTable() {
	var roomCount = Number(document.getElementById(roomCountID).value);
	var showSessions = document.getElementById(showSessionsID).checked;
	var maxRoomSize = 0;
	
	assignEveryone();

	var htmlOutput = "";

	// first we display the standard rooms
	htmlOutput += "<center><table>";
	
	htmlOutput += "<tr>";
	for (let roomNum = 1; roomNum <= roomCount; roomNum++) {
		htmlOutput += "<th>"+standardRoomName(roomNum)+"</th>";
		// need to know the largest room size for the next step
		if (finalRoomAssignments[standardRoomName(roomNum)].length > maxRoomSize) {
			maxRoomSize = finalRoomAssignments[standardRoomName(roomNum)].length;
		}
	}
	htmlOutput += "</tr>";
	
	for (let row = 0; row < maxRoomSize; row++) {
		htmlOutput += "<tr>";
		for (let roomNum = 1; roomNum <= roomCount; roomNum++) {
			htmlOutput += "<td>";
			if (finalRoomAssignments[standardRoomName(roomNum)].length > row) {
				htmlOutput += veDisplay(finalRoomAssignments[standardRoomName(roomNum)][row]);
			} else {
				htmlOutput += "&nbsp;";
			}
			htmlOutput += "</td>";
		}
		htmlOutput += "</tr>";
	}

	htmlOutput += "</table></center>";
	
	htmlOutput += "<br>";
	
	// next we display the special rooms
	htmlOutput += "<center><table>";
	
	htmlOutput += "<tr>";
	window.specialRooms.forEach(function (roomName,index) {
		htmlOutput += "<th>"+roomName+"</th>";
		// need to know the largest room size for the next step
		if (finalRoomAssignments[roomName].length > maxRoomSize) {
			maxRoomSize = finalRoomAssignments[roomName].length;
		}
	});
	htmlOutput += "</tr>";
	
	for (let row = 0; row < maxRoomSize; row++) {
		htmlOutput += "<tr>";
		window.specialRooms.forEach(function (roomName,index) {
			htmlOutput += "<td>";
			if (finalRoomAssignments[roomName].length > row) {
				htmlOutput += veDisplay(getVEbyID(finalRoomAssignments[roomName][row]));
			} else {
				htmlOutput += "&nbsp;";
			}
			htmlOutput += "</td>";
		});
		htmlOutput += "</tr>";
	}

	htmlOutput += "</table></center>";
	
	document.getElementById(outputID).innerHTML = htmlOutput;
	
}

function veInputParse() {
	var input = document.getElementById(inputID).value;
	var inputList = input.split(/\W+/);
	var selectedList = [];
	var maybeList = [];
	
	inputList.forEach(function (inputItem, inputIndex) {
							if (inputItem) {
								var matched = false;
								window.stats.forEach(function (statsItem, statsIndex) {
														  if ((statsItem.veNumber == inputItem.toUpperCase()) ||
															  (statsItem.veCallSign == inputItem.toUpperCase())) {
																matched = true;
																selectedList.push(statsItem);
															}
														});
								if (!matched) {
									// Does this look like a callsign or a VE Number?
									if (inputItem.toUpperCase().match(/^(\d{4}[EG]|[A-Z]{1,2}\d[A-Z]{1,3})$/)) {
										maybeList.push(inputItem.toUpperCase());
									}
								}
							}
						})
	
	// dedup
	selectedList = selectedList.filter(function (value, index, self) { return self.indexOf(value) === index; });
	maybeList = maybeList.filter(function (value, index, self) { return self.indexOf(value) === index; });
	
	selectedList.sort(compareBySessionsDec);
	window.selectedList = selectedList;
	
	maybeList.sort();
	window.maybeList = maybeList;
}

function veInputUpdated() {
	veInputParse();

	// Update VE Count
	var countText = selectedList.length+" VE"+ (selectedList.length==1 ? "" : "s") +" found";
	countText += (maybeList.length==0?"": " plus "+maybeList.length+" possible new VE"+ (maybeList.length==1 ? "" : "s") );
	document.getElementById(veCountID).innerHTML = countText;

	updateVEDataList();
	checkAssignmentsAndRedraw();
}


var pauseCheck = false;
function checkAssignmentsAndRedraw() {
	if (!pauseCheck) {
		// check
		validateRoomAssignments(); // will remove VEs if they have been removed from VE List or if rooms no longer exist

		// redraw
		displayRoomAssignments();
		redrawTable();
	}
}

function roomCountUpdated() {
	updateRoomDataList();
	checkAssignmentsAndRedraw();
}

function showSessionCountUpdated() {
	updateVEDataList();
	checkAssignmentsAndRedraw();
}

function veIsParticipating(veNumber) {
	var result = false;
	window.selectedList.some(function (item, index) {
		if (item.veNumber === veNumber) {
			result = true;
		}
		return result;  // this is for the "some"
	});
	return (result || window.maybeList.includes(veNumber)); // this is for the function
}

function veHasSpecialAssignment(veNumber) {
	var result = false;
	window.roomAssignments.some(function (item, index) {
		if ((item.veNumber === veNumber) && (item.room)){
			result = true;
		}
		return result;  // this is for the "some"
	});
	return result; // this is for the function)
}

function updateVEDataList() {
	var dataList = document.getElementById(assignmentDataListID);
	dataList.innerHTML = null;
	window.selectedList.forEach(function (ve, index) {
		var op=document.createElement("option"); 
		op.setAttribute("data-value",ve.veNumber); 
		op.innerText = veDisplay(ve);
		dataList.appendChild(op);
	});
	window.maybeList.forEach(function (maybe, index) {
		var op=document.createElement("option"); 
		op.setAttribute("data-value",maybe); 
		op.innerText = maybe;
		console.log(maybe);
		dataList.appendChild(op);
	});
}

function getVEfromDataListValue(value) {
	var options = document.querySelectorAll('#' + assignmentDataListID + ' option');
	var result = "";
	
    for (var i = 0; i < options.length; i++) {
        var option = options[i];

		if(option.innerText === value) {
            result = option.getAttribute('data-value');
			break;
        }
    } 
    return result;
}

function validateRoomAssignments() {
	var roomAssignments = [];
	window.roomAssignments.forEach(function (roomAssignment, index) {
		if (veIsParticipating(roomAssignment.veNumber)) {
			roomAssignments.push(roomAssignment);
		}
	});
	window.roomAssignments = roomAssignments;
}

function roomAssignmentsUpdated() {
	var count=0;
	var roomAssignments = [];
	while (document.getElementById(assignmentNumberPrefix+count.toString()) !== null) {
		var veNumber = getVEfromDataListValue(document.getElementById(assignmentNumberPrefix+count.toString()).value);
		var room = document.getElementById(assignmentRoomPrefix+count.toString()).value;
		var assignment = {"veNumber": veNumber, "room": room};
		roomAssignments.push(assignment);
		count += 1;
	}
	window.roomAssignments = roomAssignments;

	validateRoomAssignments();
	displayRoomAssignments();
	redrawTable();
	
	return true;
}

function removeAssignment(inputIndex) {
	document.getElementById(assignmentNumberPrefix+inputIndex.toString()).value=null;
	roomAssignmentsUpdated();
}

function displayRoomAssignments() {
	var innerHTML = "";
	
	innerHTML += "<table><tr><th>VE</th><th>Room</th><th></th><tr>";
	var count = 0;
	for (var index in window.roomAssignments) {
		assignment = window.roomAssignments[index];
		innerHTML += "<tr>"
		innerHTML += "<td><input id='"+assignmentNumberPrefix+count.toString()+"' data-value='"+assignment["veNumber"]+"' value='"+veDisplay(assignment["veNumber"])+"' list='"+assignmentDataListID+"' size="+assignmentNumberWidth+" onchange='roomAssignmentsUpdated();'></td>";
		innerHTML += "<td><input id='"+assignmentRoomPrefix+count.toString()+"' value='"+assignment["room"]+"' list='"+specialRoomDataListID+"' size="+assignmentRoomWidth+" onchange='roomAssignmentsUpdated();'></td>";
		innerHTML += "<td><p onclick='removeAssignment("+count.toString()+")' style='cursor:default;'>&#x2715;</p></td>";
		innerHTML += "</tr>";
		count += 1;
	}
	innerHTML += "<tr>"
	innerHTML += "<td><input id="+assignmentNumberPrefix+count.toString()+" list='"+assignmentDataListID+"' size="+assignmentNumberWidth+" onchange='roomAssignmentsUpdated();'></td>";
	innerHTML += "<td><input id="+assignmentRoomPrefix+count.toString()+" list='"+specialRoomDataListID+"' size="+assignmentRoomWidth+" onchange='roomAssignmentsUpdated();'></td>";
	innerHTML += "<td><p style='visibility:hidden;'>&#x2715;</p></td>";
	innerHTML += "</tr>";
	innerHTML += "</table>";
	
	document.getElementById(assignmentDivID).innerHTML = innerHTML;
}

function updateRoomDataList() {
	var roomCount = Number(document.getElementById(roomCountID).value);
	var dataList = document.getElementById(specialRoomDataListID);
	dataList.innerHTML = null;

	// Add the special rooms
	window.specialRooms.forEach(function (room, index) {
		var op=document.createElement("option"); 
		op.setAttribute("label",room);
		op.setAttribute("value",room); 
		dataList.appendChild(op);
	});
	// Add the regular rooms
	for (roomNum = 1; roomNum <= roomCount; roomNum++) {
		var op=document.createElement("option"); 
		op.setAttribute("label",standardRoomName(roomNum));
		op.setAttribute("value",standardRoomName(roomNum)); 
		dataList.appendChild(op);
	}
}

function specialRoomListUpdated() {
	var input = document.getElementById(specialRoomInputID).value;
	var roomList = input.split(/\W+/);
	window.specialRooms = roomList;
	
	updateRoomDataList();
}

function displaySpecialRoomList() {
	document.getElementById(specialRoomInputID).value = window.specialRooms.join("\n");
}

function saveData() {
	var data = {"veInput": document.getElementById(inputID).value,
				"roomCount": document.getElementById(roomCountID).value,
				"showSessions": document.getElementById(showSessionsID).checked,
				"roomAssignments": window.roomAssignments,
				"specialRoomInput": document.getElementById(specialRoomInputID).value,
				};
	var jsonData = [JSON.stringify(data)];
	var blobData = new Blob(jsonData, { type: "text/plain;charset=utf-8" });
	
	var defaultFileName = "sessionSetup.json";
	
	//Check the Browser.
	var isIE = false || !!document.documentMode;
	if (isIE) {
		alert("Internet Explorer not supported.");
	} else {
		var url = window.URL || window.webkitURL;
		link = url.createObjectURL(blobData);
		var a = document.createElement("a");
		a.download = defaultFileName;
		a.href = link;
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
	}
}

//loadDataFileName
function loadData() {
	var fileSelector = document.getElementById(loadDataFileNameID);
	
	fileSelector.value = "";
	fileSelector.click();
}

function dataFileNameUpdated () {
	var fileSelector = document.getElementById(loadDataFileNameID);

  if (fileSelector.value.length != 0) {
    var file = fileSelector.files[0];
    var reader = new FileReader();
    
    reader.readAsBinaryString(file);
    reader.onloadend = function() {
		var data = JSON.parse(reader.result);
		document.getElementById(inputID).value = data["veInput"];
		document.getElementById(specialRoomInputID).value = data["specialRoomInput"];
		document.getElementById(roomCountID).value = data["roomCount"];
		document.getElementById(showSessionsID).checked = data["showSessions"];
		window.roomAssignments = data["roomAssignments"];

		pauseCheck = true;
		veInputUpdated();
		roomCountUpdated();
		showSessionCountUpdated();
		specialRoomListUpdated();
		displayRoomAssignments();
		pauseCheck = false;
		checkAssignmentsAndRedraw();
	}
  }	
}

function onLoad() {
	loadJSON();
	checkDisplayWarning(); 
	displaySpecialRoomList();
	specialRoomListUpdated(); // need to do this to initialize the dropdown datalist
	displayRoomAssignments();
	document.getElementById("veInput").focus(); 
	return true;
}

</script>

<style type="text/css">
td {
    padding:2 15px;
    white-space: nowrap;
}
#statsOutput {
    width: 100%;
    overflow-x: auto;
    white-space: nowrap;
}

#warning-wrapper {
	display: none;
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	z-index: 100;
	background-color: rgba(0,0,0,0.5);
	padding: 175px 0px;
}
#warning {
	width: 50%;
	height: auto;
	margin: 0 auto;
	padding: 10px;
	position: relative;
	text-align: center;
	background-color: rgb(255,255,0);
	border-radius: 25px;
}

.column {
  float: left;
  width: 33.33%;
}

/* Clear floats after the columns */
.row:after {
  content: "";
  display: table;
  clear: both;
}

.byLine {
	position: fixed; 
	bottom: 10; 
	right: 10; 
	padding: 5; 
	border-radius: 5px;
    background: #cacaca73;
	background-color: #cacaca73; 
	font-size: x-small;
	width: 6em;
	text-align: center;
	z-index: 1000;
}

.byLine:hover #support {
	display: block;
}

.support {
	position: fixed; 
	width: 200px;
	display: none;
	bottom: 30; 
	right: 10; 
	padding: 5; 
	border-radius: 5px;
    background: #cacaca73;
	background-color: #cacaca73; 
	font-size: x-small;
	text-align: left;
	z-index: 999;
}

</style>

</head>

<body onload='onLoad();'>
	<div id=warning-wrapper>
		<div id=warning>
			This is the TEST site, probably with OLD data.<br>
			Production is here: <a href="https://malone.org/glaarg/sessionPrepStats.html">https://malone.org/glaarg/sessionPrepStats.html</a><br>
			<button type=button onclick='document.getElementById("warning-wrapper").style.display="none"; return true;'>Clear</button>
		</div>
	</div>

	<div class="headerBox">
	<center><h1>Session Prep</h1></center>
	</div>

	<form onsubmit="return false;">

	<div class="outerBox row">
		<div id="inputDiv" class="column">
		<center>
			<h2>VE List</h2>
			<textarea id="veInput" rows="10" cols="30" placeholder="Paste a list of VE #s or Callsigns here..." onchange="veInputUpdated();"></textarea>
			<br>
			<div id=veCount>0 VEs found</div>
			<br>
			Rooms: <input type=number id=roomCount value=1 min=1 max=20 onchange="roomCountUpdated();"/>
			<br>
			<input type=checkbox id=showSessions checked onchange="showSessionCountUpdated();"> Show session count
		</center>
		</div>
		
		<div id="roomAssignmentOuterDiv" class="column">
			<center>
			<h2>Special Room Assignments</h2>
			
			<div id="roomAssignmentDiv">
			</div>
			</center>
		</div>
		
		<div id="specialRoomsDiv" class="column">
			<center>
			<h2>Special Rooms</h2>
			<textarea id="specialRoomInput" rows="10" cols="30" placeholder="Paste a list of special rooms here..." onchange="specialRoomListUpdated();"></textarea>
			</center>
		</div>
		
	</div>

	<datalist id="specialRoomDataList">	</datalist>
	<datalist id="assignmentDataList">	</datalist>
	<input type=file id="loadDataFileName" style="display:none;" onchange="dataFileNameUpdated();">

	<div>
		<center>
<!-- 
			<button type=button>Go</button>
 -->
			<button onclick="saveData()">Save Setup</button>
			<button onclick="loadData()">Load Setup</button>
		</center>
	</div>

	</form>


	<div id="statsOutput">
	</div>

	<div id="byLine" class="byLine">
		by AK6DM
		<div id="support" class="support">
			&#128519; If using this page saves you time, consider supporting my efforts by giving credit for your sessions. 	
			<br>
			Every little bit helps in my quest for 150!
		</div>
	</div>
</body>
</html>
